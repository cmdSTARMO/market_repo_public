name: Workday Twice Daily Auto Run

on:
  schedule:
    - cron: '25 1 * * 1-5'  # åŒ—äº¬æ—¶é—´ 09:35 - 8
    - cron: '58 6 * * 1-5'   # åŒ—äº¬æ—¶é—´ 15:01 - 8
  workflow_dispatch:

jobs:
  run-scripts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install pandas requests openpyxl

      - name: Run daat.py with retry
        run: |
          echo "Running daat.py with up to 3 retries..."
          success=0
          for i in {1..3}; do
            python daat.py && success=1 && break || echo "Retry #$i failed, retrying..."
            sleep 5
          done
          if [ $success -eq 0 ]; then
            echo "daat.py failed after retries"
            curl -X POST -H "Content-Type: application/json" \
              -d '{"text": "âš ï¸ GitHub Actions è­¦å‘Šï¼šdaat.py æ‰§è¡Œå¤±è´¥ï¼ˆ3æ¬¡é‡è¯•åï¼‰"}' \
              https://open.feishu.cn/open-apis/bot/v2/hook/f129a3a4-9860-4917-9b14-5e63f9bf8e98
          fi
        continue-on-error: true

      - name: Run push.py with retry
        run: |
          echo "Running push.py with up to 3 retries..."
          success=0
          for i in {1..3}; do
            python push.py && success=1 && break || echo "Retry #$i failed, retrying..."
            sleep 5
          done
          if [ $success -eq 0 ]; then
            echo "push.py failed after retries"
            curl -X POST -H "Content-Type: application/json" \
              -d '{"text": "âš ï¸ GitHub Actions è­¦å‘Šï¼špush.py æ‰§è¡Œå¤±è´¥ï¼ˆ3æ¬¡é‡è¯•åï¼‰"}' \
              https://open.feishu.cn/open-apis/bot/v2/hook/f129a3a4-9860-4917-9b14-5e63f9bf8e98
          fi
        continue-on-error: true
        
      - name: List changed files before commit
        run: |
          echo "ğŸ—‚ï¸ å½“å‰æ›´æ”¹æ–‡ä»¶å¦‚ä¸‹ï¼š"
          git status

      - name: Commit and Push Generated Files
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
          git add market_data/*.csv || true
          git add *.md || true
          git add push_log.csv || true
      
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°å¸‚åœºæ•°æ®å’ŒæŠ¥å‘Šæ–‡ä»¶ï¼š$(date +'%Y-%m-%d %H:%M:%S')" || echo "Nothing to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
